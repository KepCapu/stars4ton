<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Оплата Stars — TON</title>

  <!-- TonConnect UI с модалкой кошельков -->
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <!-- Telegram WebApp SDK (по желанию) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- ton-core для сборки payload (BOC) с комментарием -->
  <script src="https://unpkg.com/ton-core@0.56.3/dist/ton-core.umd.min.js"></script>

  <style>
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif;background:#0b0f19;color:#fff}
    .wrap{max-width:740px;margin:0 auto;padding:28px}
    .card{background:#12182b;border:1px solid #1f2a44;border-radius:16px;padding:22px;box-shadow:0 8px 26px rgba(0,0,0,.35)}
    h1{font-size:22px;margin:0 0 12px}
    .row{margin:12px 0}
    code{background:#0d1426;border:1px solid #24314f;border-radius:8px;padding:6px 8px;display:inline-block;word-break:break-all}
    button{width:100%;padding:14px 16px;border-radius:12px;border:0;font-weight:600;font-size:16px;cursor:pointer}
    .primary{background:#3b6df6; color:#fff}
    .ghost{background:transparent;border:1px solid #2b3a63;color:#cfd9ff}
    .muted{opacity:.9}
    .ok{color:#9effb4}
    .err{color:#ff8c8c}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Оплата Stars через Telegram Wallet</h1>

    <div class="row muted" id="summary">
      Выберите способ для оплаты — форма перевода откроется с заполненными полями.
    </div>

    <div class="row">Получатель: <code id="addr">(пусто)</code></div>
    <div class="row">Сумма к оплате: <b id="amountTon">0</b> TON</div>
    <div class="row muted">Комментарий: <span id="memo">(без комментария)</span></div>

    <!-- мини-кнопка статуса TonConnect (Connect/Disconnect) -->
    <div class="row" id="tonconnect-button-root"></div>

    <div class="row"><button id="connectBtn" class="ghost">Подключить кошелёк</button></div>
    <div class="row"><button id="payBtn" class="primary" disabled>Оплатить</button></div>
    <div class="row muted" id="status"></div>
  </div>
</div>

<script>
  // 0) Telegram WebApp ok
  if (window.Telegram && Telegram.WebApp) Telegram.WebApp.ready();

  // 1) Параметры из URL
  const qs        = new URLSearchParams(location.search);
  const toAddress = (qs.get('address') || '').trim();
  const amountStr = (qs.get('amount')  || '').trim();  // "0.3386775"
  const memo      = (qs.get('memo')    || '').trim();

  document.getElementById('addr').textContent      = toAddress || '(пусто)';
  document.getElementById('amountTon').textContent = amountStr || '0';
  document.getElementById('memo').textContent      = memo || '(без комментария)';

  // 2) Manifest с текущего домена
  const manifestUrl = new URL('/tonconnect-manifest.json', location.origin).toString();

  // 3) Инициализация TonConnect UI
  const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl,
    buttonRootId: 'tonconnect-button-root'
  });

  const connectBtn = document.getElementById('connectBtn');
  const payBtn     = document.getElementById('payBtn');
  const statusEl   = document.getElementById('status');

  function setStatus(text, ok) {
    statusEl.textContent = text || '';
    statusEl.className = ok === undefined ? 'row muted' : (ok ? 'row ok' : 'row err');
  }

  function toNano(tonStr) {
    const [ip, frRaw=''] = String(tonStr).split('.');
    const fr = (frRaw + '000000000').slice(0, 9);
    return (BigInt(ip || '0') * 1000000000n + BigInt(fr || '0')).toString();
  }

  // 4) Собираем payload(BOC) с комментарием через ton-core (op=0)
  function makeCommentPayloadBase64(text) {
    try {
      if (!text) return undefined;
      const core = window.toncore || window.TonCore || window.ton; // на всякий
      const cell = core.beginCell().storeUint(0, 32).storeStringTail(text).endCell();
      const boc  = cell.toBoc();                       // Uint8Array
      // Uint8Array -> base64
      let binary = '';
      for (let i = 0; i < boc.length; i++) binary += String.fromCharCode(boc[i]);
      return btoa(binary);
    } catch (e) {
      console.warn('makeCommentPayloadBase64 error:', e);
      return undefined; // если что — просто уйдём без комментария
    }
  }

  async function refreshUiByConnection() {
    const connected = tonConnectUI.connected;
    connectBtn.textContent = connected ? 'Кошелёк подключён' : 'Подключить кошелёк';
    payBtn.disabled = !connected || !toAddress || !amountStr;
  }

  tonConnectUI.connectionRestored.then(refreshUiByConnection);
  tonConnectUI.onStatusChange(refreshUiByConnection);

  // 5) Подключение кошелька
  connectBtn.addEventListener('click', async () => {
    try {
      // откроется модалка, пользователь выберет Telegram Wallet (TON)
      await tonConnectUI.openModal();
      setStatus('');
    } catch {
      setStatus('Подключение отменено.', false);
    }
  });

  // 6) Оплата
  payBtn.addEventListener('click', async () => {
    setStatus('');
    payBtn.disabled = true;

    try {
      if (!tonConnectUI.connected) {
        await tonConnectUI.openModal();
        if (!tonConnectUI.connected) { payBtn.disabled = false; return; }
      }

      if (!toAddress || !amountStr) {
        setStatus('Некорректные параметры платежа.', false);
        payBtn.disabled = false;
        return;
      }

      const msg = {
        address: toAddress,
        amount: toNano(amountStr)
      };

      const payloadB64 = makeCommentPayloadBase64(memo);
      if (payloadB64) msg.payload = payloadB64; // ВАЖНО: здесь теперь BOC base64

      const tx = {
        validUntil: Math.floor(Date.now() / 1000) + 600,
        messages: [msg]
      };

      await tonConnectUI.sendTransaction(tx);
      setStatus('Запрос на оплату отправлен в кошелёк. Подтвердите транзакцию.', true);

      setTimeout(() => { if (Telegram?.WebApp?.close) Telegram.WebApp.close(); }, 1500);
    } catch (e) {
      setStatus('Не удалось отправить транзакцию. ' + (e?.message || ''), false);
      payBtn.disabled = false;
    }
  });
</script>
</body>
</html>
